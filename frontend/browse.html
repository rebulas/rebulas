<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Rebulas - Productivity for the technically minded</title>

<link href='https://fonts.googleapis.com/css?family=Lora|Titillium+Web|Open+Sans:300' rel='stylesheet' type='text/css'>
<link type="text/css" rel="stylesheet" href="style/bootstrap/css/bootstrap.css" />
<link type="text/css" rel="stylesheet" href="style/main.css" />
<link type="text/css" rel="stylesheet" href="style/terminal.css" />
<script type="text/javascript" src="style/jquery.min.js"></script>

<script src="style/terminal/jquery.terminal-1.2.0.min.js"></script>
<script src="style/terminal/jquery.mousewheel.min.js"></script>
<link href="style/terminal/jquery.terminal-1.2.0.min.css" rel="stylesheet"/>

<script src="style/markdown-it.min.js"></script>

<script type="text/javascript" src="js/util/util.js"></script>
<script type="text/javascript" src="js/ui/facet-renderer.js"></script>
<script type="text/javascript" src="js/ui/item-renderer.js"></script>
<script type="text/javascript" src="js/ui/breadcrumbs-renderer.js"></script>
<script type="text/javascript" src="js/query/query.js"></script>
<script type="text/javascript" src="js/query/query-executor.js"></script>
<script type="text/javascript" src="js/terminal/cli.js"></script>
<script type="text/javascript" src="js/query/result-model.js"></script>

<script>

$(document).ready(function() {

	// Query parameters and the item query representation
	var q = Util.parseQueryString();

	// Model holding the current query result, to be written inside the QueryExecutor
	// and read from UI components
	var resultModel = ResultModel.create();

	// All changes in the result set go through the QueryExecutor. The query execution could be
	// triggered from within UI components, this reference will be passed there.
	var queryExecutor = QueryExecutor.create(resultModel);

	// Register the current URL in the history stack in order to get a proper state in case of direct link
	history.replaceState({"queryObject" : q}, "", "?" + Util.queryObjectToString(q));

	// React on back/forward when we have state enabled
	window.onpopstate = function(event) {
		if (event.state) {
			queryExecutor.execute(event.state.queryObject, renderResult);
		}
	};

	queryExecutor.execute(q, function(result) {

		// Initial state
		// TODO must include the repository information, maybe reuse the catalog concept
		var currentPrompt = 'rebulas@github.com/rebulas:~/$s=test/client=waitrose> ';

		// The terminal prompt should reflect the current result set
		var prompt = function(callback) {
				var result = resultModel.get();
				var current = currentPrompt;

				var evaluated = current;
				if (result) {
					//evaluated += BreadcrumbsRenderer.toText(result.breadcrumbs);
				}

				callback(evaluated);
		};

		var settings = {
			"greetings" : 'Welcome to Rebulas. Enter help or h for a list of commands.',
			"name" : 'rebulas',
			"prompt": prompt
		};

		$("#terminal").terminal(function(command) {
			CommandLineInterpreter.process({
				"command" : command,
				"terminal" : this,
				"queryExecutor" : queryExecutor,
				"listener" : renderResult
			});
		}, settings);

		renderResult(result);
	});
});

function renderResult(result) {
	if (!result) {
		return;
	}

	var catalog = result.catalog;

	var facetContainer = $("#facets-container");
	FacetRenderer.renderFacets({
		"container" : facetContainer,
		"facets" : result.facets,
		"catalog" : catalog,
		"clickCallback" : renderResult
	});

	// Render the items
	var countContainer = $("#countContainer");
	countContainer.empty();

	var listerSize = result.catalog.listerSize || 40;

	if (result.count > listerSize) {
		countContainer.append("Showing " + listerSize + " out of " + result.count + " results");
	} else {
		countContainer.append("Showing " + result.count + " results");
	}

	var container = $(document.createElement("div"));
	ItemRenderer.renderList({
		"container" : container,
		"items" : result.items,
		"fields" : result.fields,
		"catalog" : catalog,
		"clickListener" : renderDetails
	});

	var itemsContainer = $("#itemsContainer");
	itemsContainer.empty();
	itemsContainer.append(container);
}

function renderDetails(item, catalog) {
	var container = $("#itemDetails");

	ItemRenderer.renderDetails({
		"container" : container,
		"item" : item,
		"catalog" : catalog,
		"saveCallback" : saveCallback,
		"cancelCallback" : saveCallback
	});

	$("#itemsContainer").hide();
	$("#itemDetails").fadeIn();
}

function saveCallback() {
	$("#itemDetails").empty().hide();
	$("#itemsContainer").fadeIn();
}

</script>

</head>
<body>
	<div class="row" style="height:100%">
		<div class="col-lg-2" id="head-container">
			<div id="header-entries-container" class="title">Rebulas</div>
			<p class="clearfix"></p>
			<div id="left-container">
				<div id="facet-views"></div>
				<ul id="facets-container" class="nav nav-list"></ul>
			</div>
		</div>
		<div class="col-lg-10" id="right-container">
			<div id="terminal" class="terminal-container"></div>
			<p class="clearfix"/>
			<h4 id="countContainer"></h4>
			<div id="itemsContainer" class="items"></div>
			<div id="itemDetails" class="item-details well" style="display:none"></div>
		</div>
	</div>


</body>
</html>
